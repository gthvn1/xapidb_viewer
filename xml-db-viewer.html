<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>XML DB Viewer</title>

<style>
body {
  font-family: monospace;
  margin: 1em;
}
details {
  margin-left: 1em;
}
.row-details {
  margin-left: 1em;
  padding: 2px 0;
}
.key {
  color: #d14; /* red for keys */
  font-weight: bold;
}
a {
  color: #0055cc;
  text-decoration: none;
}
a:hover {
  text-decoration: underline;
}
.highlight {
  background: yellow;
}
#search {
  margin: 0.5em 0;
  width: 300px;
}
</style>
</head>

<body>

<h3>XML Database Viewer</h3>

<input type="file" id="file">
<br>
<input id="search" placeholder="Search...">

<div id="out"></div>

<script>
let allRows = [];

document.getElementById("file").onchange = async e => {
  const text = await e.target.files[0].text();
  const xml = new DOMParser().parseFromString(text, "text/xml");

  const rowsByRef = {};
  allRows = [];

  xml.querySelectorAll("row[ref]").forEach(r => {
    rowsByRef[r.getAttribute("ref")] = r;
  });

  const out = document.getElementById("out");
  out.innerHTML = "";

  xml.querySelectorAll("table").forEach(table => {
    // Table details
    const tableDetails = document.createElement("details");
    const tableSummary = document.createElement("summary");

    const name = table.getAttribute("name");
    const count = table.querySelectorAll("row").length;
    tableSummary.textContent = `Table: ${name} (${count})`;
    tableDetails.appendChild(tableSummary);

    // Rows
    table.querySelectorAll("row").forEach(row => {
      const rowDetails = document.createElement("details");
      rowDetails.className = "row-details";

      const summary = document.createElement("summary");
      const rowName = row.getAttribute("name") || row.getAttribute("ref");
      summary.textContent = `Row: ${rowName}`;
      rowDetails.appendChild(summary);

      if (row.getAttribute("ref")) {
        rowDetails.id = row.getAttribute("ref");
      }

      [...row.attributes].forEach(a => {
        let value = a.value.replace(/OpaqueRef:[\w-]+/g, r =>
          rowsByRef[r]
            ? `<a href="#${r}" onclick="openTarget('${r}')">${r}</a>`
            : r
        );
        const div = document.createElement("div");
        div.innerHTML = `<span class="key">${a.name}</span>: ${value}`;
        rowDetails.appendChild(div);
      });

      tableDetails.appendChild(rowDetails);
      allRows.push(rowDetails);
    });

    out.appendChild(tableDetails);
  });
};

// Open row and parent tables when clicking a ref
function openTarget(ref) {
  setTimeout(() => {
    const el = document.getElementById(ref);
    if (!el) return;

    let p = el.parentElement;
    while (p) {
      if (p.tagName === "DETAILS") p.open = true;
      p = p.parentElement;
    }

    el.scrollIntoView({ behavior: "smooth", block: "center" });
  });
}

// Search
document.getElementById("search").oninput = e => {
  const q = e.target.value.toLowerCase();

  allRows.forEach(r => {
    // Remove previous highlights
    r.querySelectorAll(".highlight").forEach(h => {
      h.replaceWith(document.createTextNode(h.textContent));
    });

    if (!q) return;

    const text = r.textContent.toLowerCase();
    if (text.includes(q)) {
      // Highlight matches
      r.innerHTML = r.innerHTML.replace(
        new RegExp(q, "gi"),
        m => `<span class="highlight">${m}</span>`
      );

      // Expand matching row and parent tables
      let p = r.parentElement;
      while (p) {
        if (p.tagName === "DETAILS") p.open = true;
        p = p.parentElement;
      }
    }
  });
};
</script>

</body>
</html>
